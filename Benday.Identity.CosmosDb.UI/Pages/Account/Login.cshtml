@page
@model LoginModel

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Log in</title>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .login-container { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h1 { margin: 0 0 1.5rem; font-size: 1.5rem; text-align: center; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.25rem; font-weight: 600; font-size: 0.875rem; }
        input[type="email"], input[type="password"] { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
        input[type="email"]:focus, input[type="password"]:focus { outline: none; border-color: #0078d4; box-shadow: 0 0 0 2px rgba(0,120,212,0.2); }
        .btn-primary { width: 100%; padding: 0.625rem; background: #0078d4; color: #fff; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; }
        .btn-primary:hover { background: #106ebe; }
        .btn-passkey { width: 100%; padding: 0.625rem; background: #fff; color: #0078d4; border: 2px solid #0078d4; border-radius: 4px; font-size: 1rem; cursor: pointer; }
        .btn-passkey:hover { background: #f0f7ff; }
        .btn-passkey:disabled { opacity: 0.5; cursor: not-allowed; }
        .divider { display: flex; align-items: center; margin: 1rem 0; font-size: 0.875rem; color: #999; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #ddd; }
        .divider span { padding: 0 0.75rem; }
        .validation-summary-errors { color: #d32f2f; margin-bottom: 1rem; font-size: 0.875rem; }
        .validation-summary-errors ul { margin: 0; padding-left: 1.25rem; }
        .links { margin-top: 1rem; text-align: center; font-size: 0.875rem; }
        .links a { color: #0078d4; text-decoration: none; }
        .links a:hover { text-decoration: underline; }
        .links .separator { margin: 0 0.5rem; color: #999; }
        .checkbox-group { display: flex; align-items: center; margin-bottom: 1rem; }
        .checkbox-group input[type="checkbox"] { margin-right: 0.5rem; width: 1rem; height: 1rem; }
        .checkbox-group label { margin-bottom: 0; font-weight: 400; font-size: 0.875rem; cursor: pointer; }
        .passkey-error { color: #d32f2f; font-size: 0.8rem; margin-top: 0.5rem; display: none; }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>Log in</h1>
        <div asp-validation-summary="ModelOnly"></div>
        <form method="post">
            <input type="hidden" asp-for="ReturnUrl" />
            <div class="form-group">
                <label asp-for="Input.Email"></label>
                <input asp-for="Input.Email" type="email" autocomplete="email" autofocus />
                <span asp-validation-for="Input.Email" style="color:#d32f2f;font-size:0.8rem;"></span>
            </div>
            <div class="form-group">
                <label asp-for="Input.Password"></label>
                <input asp-for="Input.Password" type="password" autocomplete="current-password" />
                <span asp-validation-for="Input.Password" style="color:#d32f2f;font-size:0.8rem;"></span>
            </div>
            @if (Model.ShowRememberMe)
            {
                <div class="checkbox-group">
                    <input asp-for="Input.RememberMe" type="checkbox" />
                    <label asp-for="Input.RememberMe">Remember me</label>
                </div>
            }
            <button type="submit" class="btn-primary">Log in</button>
        </form>
        @if (Model.EnablePasskeys)
        {
            <div class="divider"><span>or</span></div>
            <button type="button" id="passkey-login-btn" class="btn-passkey" style="display:none;">Sign in with passkey</button>
            <div id="passkey-error" class="passkey-error"></div>
            <form id="passkey-form" method="post" asp-page-handler="PasskeySignIn" style="display:none;">
                <input type="hidden" asp-for="ReturnUrl" />
                <input type="hidden" name="PasskeyCredentialJson" id="passkey-credential-json" />
            </form>
        }
        <div class="links">
            @if (Model.AllowRegistration)
            {
                <a href="/Account/Register">Create an account</a>
                <span class="separator">|</span>
            }
            <a href="/Account/ForgotPassword">Forgot your password?</a>
        </div>
    </div>
    @if (Model.EnablePasskeys)
    {
        <script src="/_content/Benday.Identity.CosmosDb.UI/js/passkey.js"></script>
        <script>
            (function () {
                if (!isPasskeySupported()) return;

                var btn = document.getElementById('passkey-login-btn');
                btn.style.display = 'block';

                btn.addEventListener('click', async function () {
                    btn.disabled = true;
                    var errorEl = document.getElementById('passkey-error');
                    errorEl.style.display = 'none';

                    try {
                        var credentialJson = await startPasskeyLogin(
                            '/Account/Login?handler=PasskeyOptions',
                            '@(Model.ReturnUrl ?? "/")'
                        );

                        document.getElementById('passkey-credential-json').value = credentialJson;
                        document.getElementById('passkey-form').submit();
                    } catch (err) {
                        if (err.name !== 'AbortError' && err.name !== 'NotAllowedError') {
                            errorEl.textContent = 'Passkey authentication failed. Please try again.';
                            errorEl.style.display = 'block';
                        }
                        btn.disabled = false;
                    }
                });
            })();
        </script>
    }
</body>
</html>
